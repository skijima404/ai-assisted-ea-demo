---
date: 2025-11-07
tags: [analysis, microservices, dependencies]
confidence: ★★★☆☆
---

# サービス分割と依存関係の分析

> **GenAI向けの注意事項**: このファイルは `01_working/20_analysis/` フォルダに格納されており、確実度 ★★★☆☆（一次メモを整理した分析結果。ある程度検証されているが、確定的ではない）です。示唆は確定事項ではなく、分析段階の推論である可能性があります。最終的な意思決定には、`03_artifacts/` フォルダの成果物を参照してください。

## 観察事実 (Observation)

### 社食システムに内包されている機能群の切り出し難易度

#### 1. ユーザープロファイル (users)
- **切り出し難易度**: 低
- **データ入力**: 限定的
  - 入社時に人事システムの登録ユーザーから情報を取得してデータ更新（現在バッチ）
  - 異動時の更新不要
  - 退職はないが、今後はアカウント無効化 → 削除が必要
  - 一部ユーザー情報の画面入力はあるが、月に数回あるかないか
- **データ参照**: 画面で表示する際に参照（ユーザー表示名、メールアドレス、アクセスコントロール）

#### 2. メニュー (menu)
- **切り出し難易度**: 低
- **データ入力**: 社食の栄養士が実施、1週間に一度などまとめて
  - Writeが移行難易度を上げるなら、一時的にWriteを止め、Excel等で受け取ったデータをSQLで処理することで対応可能
- **データ参照**: 画面からの呼び出しでよく呼ばれる
- **移行の柔軟性**: どのタイミングでも移行可能
- **副次的な価値**: コントラクトテストの習熟素材として活用できる可能性

#### 3. 決済履歴 (payments)
- **切り出し難易度**: 中
- **データ入力**: 多いが決済端末からのみ
  - 入力のみ、Value Objectなので更新されない
- **データ参照**: 多機能からの参照あり
  - 内部の利用明細、請求台帳（現在はプロシージャ）
  - Target Architectureでは、この2つは人事システム側に移動し、イベント連携の予定

#### 4. 利用明細 (transactions)
- **切り出し難易度**: 中〜高
- **現状**: 決済履歴 (payments) との間の検算（社食システムのみの明細）
- **Target Architecture**: 利用履歴との間の検算（社食システムとコンビニシステムの決済履歴の合算）
- **ロジックの変更**: ロジックそのものはおそらくそれほど複雑ではない
- **移行の複雑性**: 詳細な分析が必要（後述）

#### 5. 請求台帳 (bills)
- **切り出し難易度**: 低〜中
- **現状**: インプットがCSVに限定されているので、切り出すことはそれほど難しくない
- **Target Architecture**: 利用明細との依存度高め（検算のデータソースが利用明細に切り替わる）

### 利用明細 (transactions) の移行難易度詳細分析

#### 難しい点
1. **旧と新が同じものではない**:
   - 旧: コンビニデータソース部分の利用明細
   - 新: コンビニデータソース + 社食データソースの利用明細
     - 現在は社食データソース部分は決済履歴 (payments) 部分が肩代わりしている
     - 本来人事にあるべき給料天引き金額を確認する目的なので、これは社食から切り離して人事側に移管する

2. **「同じ処理結果」を担保する基準が不明確**:
   - 1件ずつの処理ならシンプルでテストケースを今から立てられるので、リグレッションテストがないことの影響は限定的
   - 問題はネットワーク伝達を介したことによるパケットロス等の影響:
     - 「そもそも到達していないデータ」がないことを証明すること
     - 到達していないデータがあった場合でもリトライが十分であることを証明すること

#### 鏡として使えそうなもの
1. **CSV**: これまでの運用でデータロスがないことは実証済みと考える
2. **人事側の現行の請求台帳**: CSV同様、これまでの運用でデータロスがないことは実証済み
3. **これから切り出す社食システムソースのマイクロサービス**:
   - 使えないこともないが、その前にそのマイクロサービスへのデータ反映が十分であることをどう検証するか
   - レアケースが前段階で見逃されないとも限らない
   - 社内といえども支払い関連データなのでこれは少々怖い

#### 段階移行の可能性
1. **コンビニデータソース部分**:
   - 現行利用明細相当、ほぼApple to Apple
   - CSVを鏡として使える

2. **社食システムの「決済履歴」から役割を引き継いで新設するところ**:
   - コンビニデータソース部分が先に検証できると考えると、残るは決済履歴 → 新利用明細への単純なデータ同期なのでそれほど問題はなくなる
   - 複雑なのはテストの仕組みであって、機能移植ではない
   - 新利用明細サービスそのものは割とシンプルなCRUDサービス

## 示唆 (Implication)

### サービス分割の優先順位
1. **メニュー (menu)**: 最も切り出しやすく、コントラクトテストの習熟素材としても活用可能
2. **ユーザープロファイル (users)**: 切り出し難易度が低く、早期に分離できる
3. **決済履歴 (payments)**: 中程度の難易度だが、Target Architectureでは人事システム側に移動
4. **請求台帳 (bills)**: CSVインプットに限定されているため、比較的切り出しやすい
5. **利用明細 (transactions)**: 最も複雑で、段階的な移行アプローチが必要

### 依存関係の整理が重要
- **キモは利用明細と依存関係のあるものの順序整理**
- メニューは移行しやすいので、どのタイミングにもできそう
- 利用明細の移行は段階的なアプローチが必須

### データ整合性の検証方法
- CSVや人事側の請求台帳を「鏡」として使い、データロスがないことを検証
- ネットワーク伝達によるパケットロス等の影響を考慮したテスト設計が必要
- リトライ機構の十分性を証明する必要

## 改善の方向性 (Improvement Directions)

### 1. メニューサービスを最初に切り出す
- **目的**: コントラクトテストの習熟、Quick Win
- **実装方針**:
  - Read Onlyで切り出し、Writeは一時的にExcel + SQLで対応
  - コントラクトテストの習熟素材として活用
- **関連原則**: ADR-0004 (Microservices Architecture), ADR-0008 (Data Contract & Schema Evolution)

### 2. ユーザープロファイルサービスを早期に分離
- **目的**: 人事システムとのイベント連携の基盤整備
- **実装方針**:
  - バッチ処理からイベント駆動への移行
  - アカウント無効化・削除フローの実装
- **関連原則**: ADR-0006 (Security First), ADR-0003 (Event Driven Architecture)

### 3. 利用明細サービスを段階的に移行
- **目的**: リスクを最小化しながら、複雑なサービスを移行
- **実装方針**:
  - 第1段階: コンビニデータソース部分（CSVを鏡として使う）
  - 第2段階: 社食システムの決済履歴から役割を引き継ぐ部分
  - 各段階でデータ整合性を検証
- **関連原則**: ADR-0001 (Single Source of Truth)

### 4. 依存関係を考慮した移行順序の設計
- **目的**: 移行リスクの最小化
- **実装方針**:
  - メニュー → ユーザープロファイル → 決済履歴 → 請求台帳 → 利用明細の順序を検討
  - 各サービスの依存関係を可視化し、移行順序を最適化
- **関連成果物**: Transition Architecture (Phase F)

