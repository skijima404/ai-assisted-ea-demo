---
id: an-203
date: 2025-11-06
title: legacy-ui-and-bl-coupling-increases-migration-risk
status: draft
tags: [analysis, legacy, ui, migration, complexity]
---

# Legacy UI and business logic coupling increases migration risk

## Incident (Observed Behavior)
- 社食システムは画面要素が多く、古いスタイルの UI が多数存在する。
- プレゼンテーションレイヤーとビジネスロジックレイヤーが分離されておらず、境界が曖昧なコード構造になっている。
- 既存のリグレッションテストはテストケースが曖昧で、成功条件が「適切に動くこと」としか定義されていない。
- テストケースが期待するビジネス挙動を十分に表現しておらず、「何が壊れたらアウトか」がコードからしか読み取れない状態である。

## Conclusion / Assumptions
- **結論:** UI とビジネスロジックの強い結合、およびリグレッションテストの曖昧さにより、社食システムの初手リファクタリング（UI 分離・API 化・サービス分割）は高リスクであり、そのままの状態で UI/BL から着手するのは避けるべきである。
- **Assumptions:**
  - 現行コードベースの可読性・保守性は低く、変更箇所の影響範囲をテストだけでカバーすることは難しい。
  - 既存のテスト資産は「動作確認リスト」に近く、アーキテクチャ変更に耐えられる水準ではない。
  - UI 変更や画面分離は、ビジネスロジックの改変を伴う可能性が高く、バグ混入リスクが大きい。

## Reasoning
1. **UI/BL 境界が曖昧なシステムでは、画面分離がそのままビジネスロジックの再設計を意味する。**  
   - 画面ごとのイベントハンドラ内にビジネスルールが散在していると、UI を React 等に置き換えるだけでもロジックの「移植作業」が必要になる。
   - その結果、UI リプレースは単なるフロントエンド刷新ではなく、実質的にはアプリケーション全面改修に近い重作業となる。

2. **リグレッションテストが曖昧な状態では、大規模変更後の品質保証ができない。**  
   - 成功条件が「適切に動くこと」としか定義されていないテストケースは、ビジネス要件とのトレーサビリティが取れない。
   - 仕様がテストケースに埋め込まれていないため、「何を守るべきか」がわからず、安全にコードを書き換えることができない。

3. **UI/BL リファクタリングを初手に選ぶと、移行プロジェクト全体のリスクが跳ね上がる。**  
   - UI 層の改修は、ユーザー影響も大きく、見た目の変更も伴うことが多い。
   - ビジネスロジックの改変と UI 変更が同時に起きるため、不具合の原因切り分けが困難になる。

4. **テスト基盤が弱い状態では、初期ステップはできるだけ「内部構造に依存しない変更」に限定すべきである。**  
   - CSV→Kafka のようなデータ連携層の変更は、UI/BL を触らずに進められる。
   - 先にデータ流通経路や検算ルートを整備し、その後で UI/BL を段階的にリファクタリングするほうが安全である。

## Implication
- 社食システムの UI 分離や API 化を「移行の最初のターゲット」に選ぶのは危険であり、
  - まずはデータ連携層（CSV, Kafka, バッチ）の整備、
  - 並行稼働や検算機構による品質保証の確立、
  を優先すべきである。
- UI/BL への本格的な手入れは、
  - テスト戦略の再設計（an-2xx テスト関連ノード）、
  - 検算用のミラーリングパス（旧・新の結果比較）が整ってから着手するのが望ましい。
- 将来的に UI を再構築する場合は、
  - 画面単位ではなくドメイン境界単位の API/サービス設計、
  - テスト可能なビジネスロジック層の抽出、
  を先に進める必要がある。

## Observations
- 画面要素が多く、画面を据え置きにすると API の粒度が細かくなり、結局「旧画面を再現するための API 群」になってしまう懸念がある。
- コードの複雑度が高く、プレゼンテーションとビジネスロジックが分離されていない。
- 過去のリグレッションテストケースでは成功条件が「適切に動くこと」となっており、期待されるビジネス結果が明文化されていない。

## Evidence
- `01_working/ef_solutions/10_raw-notes/2025-11-06-ui-complexity.md`
