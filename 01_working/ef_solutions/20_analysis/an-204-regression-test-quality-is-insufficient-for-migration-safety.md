

---
id: an-204
date: 2025-11-07
title: regression-test-quality-is-insufficient-for-migration-safety
status: draft
tags: [analysis, testing, regression, quality]
---

# Regression test quality is insufficient for safe architecture migration

## Incident (Observed Behavior)
- リグレッションテストの成功条件が「適切に動くこと」とだけ定義されており、期待されるビジネス結果やドメインルールがテストケースに明文化されていない。
- 現在のテストケースは、画面動作のチェックリストに近く、ビジネス要件との対応関係が整理されていない。
- テストピラミッドが逆三角形になっており、E2E テストへの過剰依存が発生している。
- 単体テスト・統合テストが不足しており、変更の影響範囲を局所的に検出する仕組みが弱い。
- 一部の自動テストは存在するが、メンテナンスされておらず、結果に対する信頼性が低い。

## Conclusion / Assumptions
- **結論:** 現行のリグレッションテストの品質は、アーキテクチャ移行（UI 分離、サービス分割、イベント駆動化など）の安全性を担保できるレベルに達しておらず、「テストが通ったから安全」とは言えない状態である。そのため、移行戦略では「テストを前提とした安全性確保」ではなく、「並行稼働や検算経路による安全性確保」を組み合わせる必要がある。
- **Assumptions:**
  - ビジネス要件はテストケースよりも、コード・運用ルール・人の頭の中に残っている部分が多い。
  - 既存のテストスイートを全面的に作り直すには時間がかかり、移行プロジェクトの初期フェーズでは現実的ではない。
  - それでも「利用者の給与や請求に関わるデータの正しさ」は絶対に守る必要があり、別ルートでの保証が必須となる。

## Reasoning
1. **テストケースがビジネス要件を表現していないため、「何を守るべきか」がテストから読み取れない。**  
   成功条件が「適切に動くこと」と曖昧に定義されていると、仕様とテストのトレーサビリティが失われる。その状態で大きな構造変更を行うと、「何が壊れたら失敗なのか」を判断できない。

2. **E2E テスト過多・下位テスト不足は、移行時の変更箇所特定を極端に難しくする。**  
   UI/BL が強く結合したシステムで E2E テストに依存すると、テスト失敗が発生しても「どの層のどの変更が原因か」を切り分けるのが困難になる。アーキテクチャ移行では構造変更が多く発生するため、この状態は特に危険。

3. **自動テストがメンテナンスされていない状態では、テスト結果自体の信頼性が低い。**  
   形だけ自動化が残っていたとしても、期待値の更新やケースの見直しが行われていない場合、「グリーンでも安心できない／レッドでもノイズ」という状況に陥る。これは「テストがあるから安心」と言えない状態を意味する。

4. **以上から、大規模リファクタリングの安全性を既存リグレッションテストだけに依存するのは不適切。**  
   代わりに、並行稼働、新旧処理結果の比較、CSV や請求台帳を鏡とした検算など、別の安全ネットを設計する必要がある。

## Implication
- 移行計画上、以下の前提を明確に置く必要がある：
  - 「現行テストスイートは、大規模構造変更の品質保証基盤としては不十分」
  - 「移行フェーズでは、並行稼働・パケットミラーリング・DB/CSV 比較など、別の保証手段を組み合わせる」
- 中長期的には、
  - ドメインルールを反映した単体テスト・統合テストの再構築、
  - テストピラミッドの是正（下位テストの比率を増やす）、
  - 自動テストのメンテナンス体制の整備、
  を進める必要がある。
- 短期的には、「テストが通ったから安心」ではなく、「並行稼働や検算の仕組みがあるから安心」という設計に振るべき。

## Observations
- リグレッションテスト成功条件が曖昧で、「適切に動くこと」としか定義されていない。
- テストケースはビジネス要件というより、画面の動作確認リストに近い構造になっている。
- テストピラミッドは逆三角形になっており、E2E に偏っている。
- 自動テストは一部存在するが、メンテされておらず信頼性に欠ける。

## Evidence
- ef_solutions 向け raw-note（2025-11-07, regression-test に関する観察）