---
id: an-209
date: 2025-11-07
title: transactions-migration-is-a-key-bottleneck
status: draft
tags: [analysis, migration, transactions, data-quality]
---

# Transactions migration is a key bottleneck for safe transition

## Incident (Observed Behavior)
- 現行の「利用明細 (transactions)」と Target Architecture で想定される「利用明細」は、構造的にも責務的にも同じものではない。  
  - 旧：主にコンビニデータソースをベースにした利用明細。  
  - 新：コンビニデータソース ＋ 社食データソースの合算に基づく利用明細（給与天引き確認のための正規ビュー）。  
- 現状は、社食側の決済履歴 (payments) が「本来は人事システムにあるべき給料天引き金額確認」の役割を肩代わりしている。  
- Target Architecture では、この役割を人事側に移管し、社食システムからは切り離す方針である。  
- 利用明細の移行では、単に「同じ処理結果を再現する」のではなく、  
  - 責務の移管、  
  - データフローの再設計、  
  - ネットワーク越しのデータロス・リトライ保証、  
  を同時に扱う必要がある。

## Conclusion / Assumptions
- **結論:** 利用明細 (transactions) の移行は、単純なテーブル移行や CRUD サービス切り出しでは済まず、「責務の再定義」と「データロス検知メカニズム」を伴うため、アーキテクチャ移行全体のキーボトルネックである。段階移行と検算用の“鏡データ”を組み合わせた慎重な設計が必須となる。  
- **Assumptions:**
  - 現行 CSV や人事側の請求台帳は、これまでの運用実績から「データロスがほぼない鏡」として扱える。  
  - ネットワーク伝達を介した新アーキテクチャでは、「そもそも到達していないデータ」が発生するリスクが増える。  
  - 新利用明細サービスは機能としては比較的シンプルな CRUD だが、その前段にあるデータ伝達・同期の仕組みが複雑さの主因となる。

## Reasoning
1. **旧・新の利用明細は目的と責務が異なるため、「完全な同値性」を前提にできない。**  
   - 旧：社食アプリ上での履歴表示と簡易検算が主目的。  
   - 新：人事システム側での給与天引き金額の正として扱われることを想定。  
   → これにより、移行の評価軸は「画面表示の一致」ではなく、「人事側から見た金額の正しさ」にシフトする。

2. **ネットワークを跨ぐイベント駆動連携では、“そもそも届いていないデータ” の存在が最大のリスクになる。**  
   - パケットロスや一時的な障害により、イベントが新システム側に到達しない可能性がある。  
   - その場合、旧来の「バッチ CSV 一括連携」と比べて、ロスの検出が難しくなる。

3. **移行においては「同じ処理結果」ではなく、「ロスがないことの検証」と「リトライが十分に機能していること」の証明が必要になる。**  
   - 新利用明細のテストでは、  
     - 1件ずつの処理結果の正しさ、  
     - イベントのリトライ動作、  
     - 到達しなかったデータの検出・再送ロジック、  
     を検証対象に含める必要がある。

4. **段階移行によって複雑さを分割できる。**  
   - コンビニデータソース部分の利用明細：  
     - 現行利用明細との対応関係が明確であり、CSV を“鏡”として検証しやすい。  
   - 社食データソース部分（決済履歴からの役割引き継ぎ）：  
     - コンビニ側の利用明細が先に安定すれば、残るは「決済履歴 → 新利用明細」間の単純なデータ同期として扱える。  
     - 複雑なのは移行テストの仕組みであって、必ずしもビジネスロジックそのものではない。

5. **新利用明細サービスはロジックとしては比較的シンプルだが、「どのデータを正とするか」「どのレイヤーで検算するか」の設計が難所となる。**

## Implication
- 利用明細移行は、移行ロードマップの中でも「後ろのフェーズ」に位置付け、  
  - コンビニデータソース部分の先行検証、  
  - 社食決済データの段階的移行、  
  - CSV / 現行請求台帳による検算、  
  を組み合わせた多段構えの戦略が必要となる。  
- 監査・説明責任の観点からも、  
  - 「どの時点で、どのデータを正とみなしたか」  
  - 「どのような検算・再送メカニズムを持っていたか」  
  を説明できるよう、アーキテクチャドキュメントとログ設計を揃えておく必要がある。  
- 新利用明細サービスの API／スキーマ設計は、単なる技術仕様ではなく、「人事側の責務境界」とセットで定義し直す必要がある。

## Observations
- 旧利用明細と新利用明細は「同じもの」ではなく、コンビニ＋社食の合算や責務移管が伴う。  
- 現行 CSV や人事側請求台帳は、データロスがない“鏡”として利用できる。  
- 新利用明細サービスは CRUD としてはシンプルだが、前段のデータ流通・同期の仕組みが複雑であり、そこがボトルネック。  
- 利用明細そのものも、コンビニ・社食といったデータソース単位で段階移行する案が存在する。

## Evidence
- ef_solutions 向け raw-note（2025-11-07, 利用明細 (transactions) の移行難易度に関する観察）
