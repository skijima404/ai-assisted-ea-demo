---
id: an-205
date: 2025-11-07
title: parallel-run-and-result-comparison-as-regression-test-alternative
status: draft
tags: [analysis, testing, migration, parallel-run]
---

# Parallel run and result comparison as an alternative to weak regression tests

## Incident (Observed Behavior)
- 旧システムの処理結果は、割引ロジックなど一部の例外を除けば、長年の運用実績から一定の信頼がおかれている。
- 一方で、既存のリグレッションテストは成功条件が曖昧であり、アーキテクチャを大きく変えた場合の品質保証には使えない（an-204 参照）。
- Mike Amundsen の STAR などで紹介されているように、新旧システムを並行稼働させ、同一入力に対する処理結果を比較する手法が存在する。
- OpenShift や監視ツール、API Gateway、Service Mesh などにより、デプロイ直後の振る舞い監視や Canary Release を行う基盤は用意できる見込みがある。

## Conclusion / Assumptions
- **結論:** 現行のリグレッションテスト品質に依存するのではなく、旧システムと新システムを並行稼働させ、同一入力に対する処理結果を比較・検証する「並行稼働＋結果比較」を、移行フェーズにおける主要な品質保証手段として採用すべきである。
- **Assumptions:**
  - 旧システムの処理結果は、少なくとも割引に関する一部の欠陥を除き、「現行業務上の正」とみなせる。
  - 並行稼働期間中は、同一入力データを旧・新の両方に流すためのルーティング（またはデータ複製）を準備できる。
  - OpenShift 等のプラットフォーム上でメトリクスを収集し、デプロイ直後に異常を検知できるだけの監視基盤を整備できる。

## Reasoning
1. **既存のリグレッションテストは「何を守るか」を表現できていない。**  
   そのため、「テストがグリーンだから安心」とは言えず、大規模な構造変更の安全性を担保するには不十分である（an-204）。

2. **旧システムは長期間の本番運用に耐えてきたという意味で、“実績ベースの期待結果” を提供してくれる。**  
   割引ロジックのような既知の欠陥を除けば、旧システムの処理結果は業務的に受け入れられてきたものであり、「比較用の鏡」として利用できる。

3. **STAR で示されるような「同一入力を新旧双方に流し、結果を比較する」アプローチは、テストケースを書き直すよりも早く、広いカバレッジを得られる。**  
   - パケットミラーリングやイベント複製により、実際のトラフィックを新システムにも流せる。
   - DB もしくはログレベルで処理結果を取得し、差分を分析できる。

4. **OpenShift や Service Mesh、API Gateway などの基盤があれば、ダークローンチや Canary Release と組み合わせて安全に並行稼働を行える。**  
   - 初期はユーザー非公開の状態（ダークローンチ）で新システムにトラフィックを流し、結果比較のみ行う。
   - 問題がないことを確認してから、一部ユーザーに対してのみ新システムを公開する Canary Release に移行できる。

5. **このアプローチにより、「弱いテストスイートを前提に無理に大規模リファクタリングを進める」リスクを下げられる。**

## Implication
- 移行戦略では、以下を前提とした設計に切り替える必要がある：
  - 旧システムと新システムを一定期間並行稼働させること。
  - データ入力（イベント／リクエスト）を新旧に複製し、処理結果を比較できるようにすること。
  - 比較ロジックや差分レポートを、単発のスクリプトではなく継続的に運用可能な仕組みとして設計すること。
- これは、テストピラミッドを一気に是正する代わりに、
  - 並行稼働、
  - 結果比較、
  - プラットフォームレベルの監視強化、
 という形で「別軸の品質保証」を用意する、という戦略的な選択である。

## Observations
- STAR (Mike Amundsen) などで、新旧システムの並行稼働と結果比較に基づく移行手法が紹介されている。
- OpenShift や監視ツール、API Gateway、Service Mesh を用いることで、デプロイ直後の挙動監視や Canary Release を行うための基盤は用意できる見込みがある。
- 現行のリグレッションテストは、移行の安全性をそのまま委ねるには不安が残る品質である。

## Evidence
- ef_solutions 向け raw-note（2025-11-07, 並行稼働および STAR に関する観察）
