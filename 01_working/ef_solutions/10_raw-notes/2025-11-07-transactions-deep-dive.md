---
date: 2025-11-07
tags: [raw]
---

# Raw Note

## 気づき (Observation)

利用明細 (transactions) ドメインの移行難易度を詳細分析した結果、Baseline の段階で「旧と新では前提となるデータモデルが根本的に異なる」ことが明確になった。

### 1. Baseline の “利用明細” は実質的に 2 つの別物
- **旧（Baseline）**
  - コンビニデータの line-item 集合（`convini_receipt_items`）
  - レシート単位の集計値（割引・小計・消費税など）は存在しない
  - 社食データ由来の決済（`receipts` / `receipt_items`）とはデータモデルが非対称

- **新（Target Architecture）**
  - 社食 + コンビニ双方の line-item を統合し、レシート粒度の検算を担う “正しい利用明細（transactions）”
  - 社食側では `payments` が代替的に肩代わりしていた「給与天引き用の決済情報」を本来の人事側へ移管する

### 2. Baseline のモデルが新設トランザクションの妥当性検証を難しくする
- 旧と新が **同じ構造ではない** ため、リグレッションテストは単純比較にならない
- 特に以下の点が難易度を上げる：
  - ネットワークを介した配送の遅延・パケットロスをどう検証するか
  - 「到達していないデータがないこと」をどう証明するか
  - リトライロジックが十分であることの検証

### 3. 新 transactions の検証に使える “鏡 (Oracle)” の候補
- **CSV（コンビニ側）**
  - 長期運用でデータロスが発生していない実績がある
- **人事側の現行請求台帳**
  - 同じく長期運用の蓄積があり、データ整合性の基準として使える
- **新設される社食側マイクロサービス**
  - ただし、これ自身の反映保証の検証が先に必要となり、Oracle として使うには慎重さが必要

### 4. 段階移行の可能性
- **コンビニ側の line-item → 新 transactions の一部に先行移行**
  - 現行の構造と近いため、ほぼ Apple to Apple
  - CSV を鏡として利用可能
- **社食側の payments → 新 transactions の “肩代わり部分”**
  - line-item の整合性検証が終わった段階で単純同期に移行可能
  - 複雑なのは “機能移植” ではなく “テスト設計” の方である

## 疑問 (Question)
- Baseline の非対称構造をどう Target 用に対称化するか。
- 検算工程をどの段階で切り替えるべきか。

## 次アクション (Next Step)
- payments → transactions → bills の責務分離と移行順序を具体化する
- CSV / 現行請求台帳を用いた検証スキームのプロトタイプを作成する