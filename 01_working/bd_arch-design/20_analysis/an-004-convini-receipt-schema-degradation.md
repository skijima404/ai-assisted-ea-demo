---
id: an-004
date: 2025-11-06
title: convini-receipt-schema-degradation
status: draft
tags: [analysis, convini, schema, data-integrity]
---

# Incident (Observed Behavior)
- 社内コンビニで受け取ったレシート（割引後の正しい金額）と、社食アプリの履歴画面（割引前の小計）の金額が一致しない事象が頻発した
- ユーザーは「社食アプリの表示が信用できない」と認識し、人事・社食双方に問い合わせが発生
- 調査の結果、**社内コンビニ側ではレシート全体に割引が適用されているのに、社食システムへの連携テーブルはラインアイテム小計しか保持していない** ことが判明した
- 従って社食アプリでは割引後金額を再現できず、不整合が構造的に発生していた

# Conclusion
**社内コンビニの2層構造（レシート＋明細）データを社食システム側で1層化して取り込み、割引属性を喪失したことで、決済金額を正しく再現できない「スキーマ劣化」が発生した。**

# Assumptions / Hypotheses
- 社内コンビニ本体システムは「レシートヘッダ」と「ラインアイテム」の2層構造を持っている前提
- 社食システム側の `convini_receipt_items` テーブルは、明細レベルのみを保持する設計であり、割引情報（レシートレベル属性）を保持するフィールドが存在しない
- スキーマ変換時、レシートヘッダ情報（割引後合計、割引種別、割引適用フラグ等）が破棄されている
- 社食側の画面表示ロジックは「明細の合計値」から金額を算出しており、割引後の正しい決済金額を復元できない

# Reasoning
- コンビニでの決済は「レシート単位」で割引が適用される  
  → 小計（割引前）と決済金額（割引後）は異なる
- しかし社食側では **明細しか保持しない1層構造** に変換されて取り込まれている  
  → レシートヘッダ（割引後の合計）が失われる
- 結果として社食側アプリは「割引後金額」を算出できず、常に割引前の小計を表示してしまう
- これは UI/ロジックの問題ではなく **構造的に再現不能なデータ損失** であり、仕様変更では解決不可能
- さらに社食アプリはコンビニ領域のデータ保持を前提としており、スキーマ劣化がアプリ境界の責務逸脱と組み合わさって問題を悪化させた

# Implications
- コンビニ領域のデータを保持する場合は、本来の構造（2層構造）を維持して取り込む必要がある  
  → スキーマ変換時に情報損失を起こさない “構造準拠” の導入が必須
- Transition Architecture では、  
  - `receipts`（ヘッダ）  
  - `receipt_items`（明細）  
  の2層構造に統一することで金額再現性を確保できる
- データ境界を越えた取り込み時の **構造劣化は将来の整合性問題の主要因となる**  
  → Integration Pattern の再設計が必要
- 今後も別領域のデータを統合する場合、**“最低限保持すべき属性” の定義** を行い、データ損失を防ぐガバナンスが必要

# Observations
- `convini_receipt_items` テーブルは明細レベルの項目のみ保持している  
- レシート単位の割引情報（割引後金額／割引種別／割引適用フラグ）が存在しない  
- そのためレシートの小計と決済金額を再構成できない
- 結果として表示金額と実決済金額の乖離が恒常的に発生している

# Evidence
- raw-notes/2025-11-06-convini-receipt-items.md
- raw-notes/2025-11-06-other-complaints.md