---
date: 2025-11-06
tags: [analysis]
confidence: ★★★☆☆
---

# 金額不整合問題の根本原因分析

> **GenAI向けの注意事項**: このファイルは `01_working/20_analysis/` フォルダに格納されており、確実度 ★★★☆☆（一次メモを整理した分析結果。ある程度検証されているが、確定的ではない）です。示唆は確定事項ではなく、分析段階の推論である可能性があります。最終的な意思決定には、`03_artifacts/` フォルダの成果物を参照してください。

## 観察事実 (Observation)

### 問題の発生経緯
健康経営推進の一環として、チーム会議用の飲食費10％割引制度を導入。社食・コンビニ双方で適用されたが、給与天引き額との突合で**金額不整合**が多数発覚。問い合わせ件数が急増し、社員の不信感と運用負荷が顕在化した。

### 社食側の問題
- **ユーザー発見経緯**: 社食の決済端末で10%割引適用後に決済したが、PC操作時の履歴画面では割引未適用金額が表示されていた
- **調査結果**: 
  - 天引きシステム側の連携金額は割引適用済み（正しい）
  - 履歴確認画面のデータソーステーブルと、人事側への連携のデータソーステーブルが異なっていた
    - 画面表示は明細テーブルを参照して計算していた
    - 人事側の連携情報は、決済金額テーブルを参照していた
- **根本原因**: 
  - 表示ロジックと精算ロジックが分離していた
  - 金額計算の責務が曖昧であったこと
  - 異なる経路で生成された金額情報の不整合を検出する仕組みがなかったこと

### コンビニ側の問題
- **問題の症状**: 社内コンビニから受け取ったレシートと、履歴画面の金額がずれている
- **原因**: 
  - 社内コンビニシステムから受け取ったデータが、社食システム内ではレシートのラインアイテムレベルのデータしかない
  - 合計金額算出後に適用される割引金額が反映されない
  - 結果として社食アプリ上ではレシートの小計（割引前）が表示され、実際の決済金額（割引後）と不一致が生じている

### テーブル設計の比較
- **社食側テーブル設計**: 
  - `receipts` テーブル（レシート全体）と `receipt_items` テーブル（明細）の2層構造
  - 割引は想定されずに作られており、テーブル設計にも反映されていない
  - しかし、2層構造により割引情報を保持する余地はある
- **コンビニ側テーブル設計**: 
  - `convini_receipt_items` テーブルのみ（明細単位のみ）
  - 割引やクーポンはレシート全体に対して適用されるが、明細単位でしか記録できない
  - 同期元のコンビニシステム側は2層構造のテーブル構成になっているため、社食システム側の実装の問題

### なぜこの問題が発生したか
- 初期開発段階では、社食で「割引」というユースケースが想定されていなかった
- 人材が入れ替わり、知見が失われた
- 割引制度導入にあたり、決済端末部分のパートナーには依頼を送ったが、バックエンド側のパートナーには声をかけていなかった

## 示唆 (Implication)

### アーキテクチャ上の問題
1. **責務の分離と整合性の欠如**: 表示ロジックと精算ロジックが分離されているが、整合性を保証する仕組みがない
2. **データモデルの不整合**: 社食側は2層構造だが割引情報を持たず、コンビニ側は1層構造で割引を表現できない
3. **システム間連携の不整合**: コンビニシステム側は2層構造だが、社食システム側が1層構造で受け取っている

### プロセス上の問題
1. **知識管理の欠如**: 人材の入れ替わりにより、システムの設計意図や制約が失われた
2. **変更影響範囲の見落とし**: 割引制度導入時に、フロントエンドだけでなくバックエンドへの影響も考慮すべきだった
3. **検証プロセスの不足**: 異なる経路で生成された金額情報の不整合を検出する仕組みがない

### 改善の方向性
1. **データモデルの統一**: レシート情報は2層構造（receipts + receipt_items）で統一し、割引情報を明示的に保持する
2. **整合性チェックの仕組み**: 表示ロジックと精算ロジックで使用する金額情報の整合性を検証する仕組みを導入
3. **知識の文書化**: システムの設計意図や制約を文書化し、変更時の影響範囲を明確にする

## 未確認事項

### データ整合性を保証する仕組み
- 決済イベントを発行する際のイベントスキーマ（割引情報を含むか）
- 表示ロジックと精算ロジックが同一のイベントソースからデータを取得する設計方針（イベントソーシングパターンなどで対応できる可能性あり。要調査）
- コンビニシステムからの連携方法（イベント連携、REST APIなど。要調査）

### 移行・実装時の確認事項
- 既存データの移行方針（既存のreceipts/receipt_itemsテーブルからの移行）
- コンビニシステム側のデータ構造（2層構造のデータを取得できるか）

