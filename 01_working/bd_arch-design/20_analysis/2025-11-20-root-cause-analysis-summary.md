---
date: 2025-11-20
tags: [analysis, root-cause, failure-analysis]
confidence: ★★★★☆
---

# Root Cause Analysis Summary: Payment Inconsistency & System Failure

> **GenAI向けの注意事項**: このファイルは `01_working/20_analysis/` フォルダに格納されており、確実度 ★★★☆☆（一次メモを整理した分析結果。ある程度検証されているが、確定的ではない）です。示唆は確定事項ではなく、分析段階の推論である可能性があります。最終的な意思決定には、`03_artifacts/` フォルダの成果物を参照してください。

本ドキュメントは、社食システムおよび社内コンビニ決済において発生した「金額不整合」および「システム障害」の根本原因を、複数のRaw Noteから統合・分析したものである。

## 観察事実 (Observation)

### 1. 事象の概要
- **金額不整合**: 社食・コンビニでの「10%割引」適用後の金額が、給与天引き額（正）とアプリ上の履歴表示（誤）で不一致が発生。
- **ユーザーの反応**: 問い合わせが急増し、システムへの不信感が定着。「またか」と諦めの境地に至っている。

### 2. 技術的要因 (Technical Factors)
- **データソースの不一致**:
  - **給与天引き連携**: 決済金額テーブル（割引適用済み）を参照。
  - **アプリ履歴表示**: 明細テーブル（割引未適用）を参照してオンザフライで計算。
  - **結果**: 表示ロジックと精算ロジックが分離しており、両者の整合性を担保する仕組み（Single Source of Truth）が存在しなかった。
- **テーブル設計の不備**:
  - **社食側**: `receipts` + `receipt_items` の2層構造だが、割引情報を保持するカラムがない。
  - **コンビニ側**: `convini_receipt_items` の1層構造のみ。レシート単位の割引を明細行に表現できず、情報落ちが発生している。

### 3. 組織・プロセス的要因 (Organizational & Process Factors)
- **コンウェイの法則の逆転**:
  - 社食システムが、管轄外である「社内コンビニ」のデータを抱え込んだ（予算・スケジュールの都合）。
  - その結果、コンビニ側の仕様変更（割引導入など）に対する感度が低く、適切なデータモデル設計が行われなかった。
- **変更管理の欠如**:
  - 「割引制度」というビジネスルールの変更が、決済端末ベンダーへの依頼のみに留まり、バックエンドシステムへの影響調査が漏れていた。
  - 人材の入れ替わりにより、初期の設計意図（なぜコンビニデータを社食が持っているか等）が失われていた。

## 示唆 (Implication)

### 根本的な失敗原因 (Root Cause of Failure)
単なるバグではなく、以下の複合要因による**構造的な失敗**である。

1.  **ドメイン境界の歪み**: 社食システムがコンビニドメインを侵食しており、責務が曖昧。
2.  **Single Source of Truth の欠如**: 「支払う金額」と「表示する金額」が別のデータソースから導出されている。
3.  **アーキテクチャガバナンスの不在**: ビジネス要件（割引）追加時に、アーキテクチャへの影響（データモデル、整合性）をレビューするプロセスがなかった。

## 改善の方向性 (Improvement Directions)

### 1. データモデルの正規化とSSOTの確立
- **方針**: 「決済確定金額」を唯一の正解情報として保持する。
- **実装**:
  - レシートデータモデルを `receipts` (Header) + `receipt_items` (Line) に統一。
  - 割引額・確定金額は Header に永続化し、再計算に依存しない。

### 2. ドメイン境界の是正
- **方針**: 社食システムからコンビニ責務を切り離す。
- **実装**:
  - 短期的には ACL (Anti-Corruption Layer) で防衛。
  - 中長期的には人事/決済基盤へデータを移譲（詳細は `organizational-boundary-mismatch.md` 参照）。

### 3. 変更管理プロセスの強化
- **方針**: ビジネスルール変更時のアーキテクチャレビューを必須化。
- **実装**:
  - 新規要件（割引など）がデータモデルや整合性に与える影響を評価するチェックリストの導入。
