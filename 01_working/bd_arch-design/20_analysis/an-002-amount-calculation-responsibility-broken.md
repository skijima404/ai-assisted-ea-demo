---
id: an-002
title: amount-calculation-responsibility-broken
status: draft
tags: [analysis, amount-inconsistency, data-responsibility]
date: 2025-11-06
---

# Incident（Observed Behavior）
- 履歴画面では割引前の金額が表示されており、給与天引き金額（割引後）と一致しない
- ユーザーは「割引が反映されていない」と認識し、問い合わせが急増した
- 社内コンビニ利用についても、レシート（割引後）とアプリ表示（割引前）の不一致が頻発
- これにより、社食アプリの金額表示に対する信頼性が低下し、運用負荷が増大した

# Conclusion
**金額計算の責務が複数箇所に分散し、表示ロジックと精算ロジックが乖離した結果、割引適用可否や合計金額が経路によって異なる「金額不整合」が発生している。**

# Assumptions / Hypotheses
- 「画面表示」と「給与天引き」の金額が別々のテーブル・別々の計算方式で生成されている前提
- 割引は決済端末側で適用されるが、明細テーブルは割引情報を保持できない前提
- 決済履歴テーブル・人事連携テーブルのスキーマが異なり、両者を突合する仕組みが存在しない
- システム初期構築時に割引ユースケースが存在せず、後付けで整合性を崩した

# Reasoning
- 決済画面の履歴表示は「明細テーブルから計算」しており、割引情報を保持していない  
  → 表示金額は割引前になる
- 人事連携は「決済金額テーブル（割引後）」を参照  
  → 精算金額は正しい
- つまり **表示と精算が異なるソーステーブルに基づいており、責務分離が成立していない**
- 割引情報の不在、2層構造の欠落、コンビニ取り込み時のスキーマ劣化などはすべて  
  **“金額責務の分散” が誘発した副次的問題**

# Implications
- 金額計算は単一責務として中央化する必要がある  
  - 「単一の金額計算サービス」または  
    「2層構造（receipt + items）に統一」
- Baseline Architecture では「金額計算の多経路化」を重大な構造的リスクとして扱うべき
- Transition Architecture では  
  1) 金額テーブルの正規化  
  2) 割引属性の導入  
  3) 表示と精算のソース統一  
  を優先施策として扱う
- UX・問い合わせ件数・人事工数の増大は “この結論が原因” の派生症状であり、単なるUI改善では解決しない

# Observations
- 履歴画面は割引前の明細から計算していた  
- 人事連携は割引後金額を参照していた  
- 割引情報がテーブル構造に存在しなかった  
- コンビニ連携テーブルは1層構造のため、小計しか持てない

# Evidence
- raw-notes/2025-11-06-amount-incosistency.md
- raw-notes/2025-11-06-canteen-table-design.md
- raw-notes/2025-11-06-convini-receipt-items.md
- raw-notes/2025-11-06-other-complaints.md