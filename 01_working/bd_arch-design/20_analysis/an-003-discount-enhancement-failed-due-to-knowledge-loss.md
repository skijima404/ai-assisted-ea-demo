---
id: an-003
date: 2025-11-06
title: discount-enhancement-failed-due-to-knowledge-loss
status: draft
tags: [analysis, discount, knowledge-loss, enhancement]
---

# Incident (Observed Behavior)
- チーム会議向けの飲食費10%割引制度導入後、給与天引き額と履歴画面の金額の不整合が多数発生した
- 社食側・人事側・社内コンビニ側の窓口がそれぞれ対応する形となり、問い合わせ対応工数が増大した
- 調査の結果、「天引きは正しいが、画面表示のみ誤っている」ケースが繰り返し確認された
- 割引ロジックが社食システムの一部のコンポーネントだけに実装され、全体の整合性が取れていないことが後から判明した

# Conclusion
**割引制度導入時に、初期設計の知見が失われた状態で部分的なエンハンスを実施した結果、本来バックエンド側で統合すべき金額計算ロジックが決済端末側にのみ実装され、システム全体の金額整合性が破綻した。**

# Assumptions / Hypotheses
- 初期構築時の設計意図（割引を想定しないデータモデル／ロジック構造）は、ドキュメントにもチームにも十分共有されていなかった
- 割引導入プロジェクトでは、ユーザーに近い決済端末側のパートナーのみがアサインされ、バックエンド側の担当者は参画していない
- 要件定義時に「どのレイヤーで割引を表現・保持すべきか」の検討が行われていない
- プロジェクト計画・予算・スケジュール上の制約により、「既存構造には触れずにフロント側だけで対応する」ことが暗黙の方針になっていた

# Reasoning
- 初期開発段階では「割引」というユースケースが想定されておらず、テーブル設計や金額計算ロジックに割引の表現力がなかった
- その状態で割引制度導入が決まり、決済端末側のパートナーにのみ改修依頼が行われた  
  → バックエンド・データモデル側の設計責任者が不在のまま進行
- 結果として、割引は決済端末でのみ適用され、  
  - 画面表示用の金額  
  - 天引き用の金額  
  が別々の経路で計算・保持される構造になった
- 知見の断絶により、  
  「どこで金額計算を一元化すべきか」  
  「どのテーブルに割引情報を持たせるべきか」  
  という本質的な設計判断が行われないまま、局所最適な実装が選択された
- その結果、金額不整合の根本原因となる「金額責務の多元化」が発生した

# Implications
- 割引制度のような **ビジネスルールの変更を伴うエンハンスは、UI層だけで完結させてはならない**  
  → ドメインルールを保持するレイヤー（バックエンド／データモデル）を含めた設計見直しが必須
- 知見の属人化・継承不備により、**過去の設計制約を踏まえないエンハンスがシステム全体の整合性を壊す** ことが明確になった
- Transition Architecture では、  
  - 割引を含む「金額計算ドメイン」の責務レイヤーを再定義する  
  - UI/端末側には“結果の表示”のみを担当させる  
  といった責務再分割が必要
- 組織面では、  
  - エンハンス時に初期設計者／バックエンド担当を巻き込むプロセス  
  - 設計意図・制約事項を残す Architecture Repository  
  を整備しない限り、同種の事故は繰り返される

# Observations
- 初期構築時、社食システムのテーブル設計には「割引」という概念が存在しなかった
- 割引制度導入時、決済端末側のパートナーにのみ依頼が行われ、バックエンドのパートナー／担当者は参画していなかった
- 社内に知見が残っておらず、「どのレイヤーで割引を扱うべきか」の設計検討が行われていない
- 結果として、割引は決済端末側で適用されるのみで、履歴画面や人事連携との整合が取れない状態になった

# Evidence
- raw-notes/2025-11-06-cause-of-failure.md
- raw-notes/2025-11-06-amount-incosistency.md
- raw-notes/2025-11-06-canteen-table-design.md