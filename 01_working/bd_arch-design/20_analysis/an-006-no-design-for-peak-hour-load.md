---
id: an-006
date: 2025-11-06
title: no-design-for-peak-hour-load
status: draft
tags: [analysis, performance, load, scalability, cost-efficiency]
---

# Incident (Observed Behavior)
- 社食アプリのアクセスが **12:00–13:00 に極端に集中**し、この時間帯のみレスポンス遅延が発生するケースが確認されている
- メニュー閲覧は 11:30 頃から急増し、決済・履歴アクセスは 12:10–13:00 に集中している
- 社内イベント日（納会・全社ミーティングなど）は利用率が通常の 50% → 70% に増加し、**この日だけ明確な性能劣化**が起きる
- **リソース効率の悪化**: ピーク負荷（イベント日基準）に合わせてインフラを固定的にサイジングしているため、**それ以外の99%の時間帯でリソースが遊んでおり、著しいコスト非効率（Over-provisioning）が発生している**

# Conclusion
**社食アプリの利用パターン（昼休み集中型）に対し、現行の「ピーク時最大負荷に合わせた固定リソース運用」は、性能面でのリスクだけでなく、コスト効率の観点でも破綻している。**

# Assumptions / Hypotheses
- 社食利用は勤務時間制度に依存し、ほぼ全員が 12:00–13:00 に利用する行動パターンである
- 現行システムはオートスケーリング前提で設計されておらず、イベント日に備えて「常に最大構成」または「手動での一時的な増強」を行っている
- バックエンド・DB・API は同期処理中心であり、ピーク分散設計（キューイング／CQRS／キャッシュ）が導入されていない
- システム構築当時、クラウドネイティブな「使った分だけ払う（Pay-as-you-go）」モデルへの最適化が考慮されていなかった

# Reasoning
- ユーザー行動が昼休みに集中するため、ピーク負荷は「設計上予測可能な現象」
- しかし、アーキテクチャが **Static Sizing（静的サイジング）** に留まっているため：
  1.  **性能リスク**: イベント日などの突発的なスパイクに耐えられない（スケールアウトできない）
  2.  **コストリスク**: 1日のうち1時間のために、残り23時間分の過剰なリソースコストを払い続けている
- 特にイベント日は利用が 7 割に跳ね上がるが、  
  **“ピーク前提のアーキテクチャ” が存在しないため、突発的遅延が発生し、かつその対策としてのリソース増強がコストを圧迫する悪循環** に陥っている
- 負荷増大によるレスポンス遅延は UX 品質低下につながり、  
  社食アプリ利用そのものが避けられる負のループを生んでいる

# Implications
- 性能要件は「平均値」ではなく **ピーク特性（worst-case）** を基準にしつつ、**コスト効率（Cost Efficiency）** を主要な非機能要件として定義し直す必要がある
- Transition Architecture では以下が必須：
  - **オートスケーリング基盤**: 負荷に応じてリソースを伸縮させる（K8s HPA / Serverless）
  - **ピークオフロード**: 静的コンテンツ（メニュー等）のCDN化、更新処理の非同期化
  - **リソース最適化**: アイドルタイムのインスタンス数削減
- Baseline Architecture では  
  **“ピーク負荷に耐えられず、かつ高コストな現行構造”** を構造的リスクとして明示的に扱う必要がある
- 単なる「性能改善」ではなく、「クラウドネイティブ化によるコスト構造の変革」として位置づけるべき

# Observations
- ランチタイム（12:00–13:00）のみアクセスが急増
- 社員 10,000 名中 5,000 名が利用、イベント日は 7,000 名が利用
- 負荷は時間帯依存であり、予測可能なパターン
- イベント日に合わせて手動でリソース増強を行っているが、根本的な解決策になっていない
- アイドルタイムのリソースが無駄になっている

# Evidence
- raw-notes/2025-11-06-system-load.md