# Ops Invariants (Draft)
運用上「絶対に壊してはいけない前提条件（インバリアント）」をまとめたドキュメント。  
アーキテクチャレビューおよびCI/GenAIレビューは、ここに記載されたインバリアントを  
**破っていないかどうか** を重点的に確認する。

---

## 1. Purpose

- 運用チームの「暗黙の前提」を明示し、設計・実装と共有する。
- レビュー観点を「不可逆な運用リスク」に集中させる。
- Daily Build ではなく、スプリント単位のアーキテクチャレビューで参照する前提とする。

---

## 2. Scope

このドキュメントは以下の領域を対象とする：

- アプリケーションの再起動性・冪等性
- デプロイ／ロールバック戦略
- 障害時の復旧可能性
- 監視・ログによるトラブルシュート性

---

## 3. Invariants

### 3.1 Availability & Restartability

**INV-OPS-001: 再起動可能であること**

- アプリケーションはいつでも再起動でき、再起動後に整合した状態に戻せること。
- ローカルディスクの一時ファイルのみを単一の真実とみなさないこと。
- Pod/プロセスの再起動でシステム全体が破綻しないこと。

> Check例（CI/AI）  
> - ローカルファイルにのみ永続状態を書いていないか  
> - 再起動時に再構築不能な一時状態に依存していないか

---

### 3.2 Idempotency & State

**INV-OPS-002: 更新系処理の冪等性（または非冪等の明示）**

- 更新系API／ジョブは、原則として冪等であること。
- 冪等でない場合は、その理由とリトライ戦略をADRに明示すること。
- メッセージの重送が起きても、致命的な不整合にならない設計とすること。

> Check例  
> - 「同じメッセージが2回処理されたらどうなるか？」を説明できるか  
> - 非冪等処理に対するガードや設計意図がADRに存在するか

---

### 3.3 Deployment & Rollback

**INV-OPS-003: ロールバック不能なスキーマ変更は禁止**

- DBスキーマ変更は、常に前方互換または後方互換を意識すること。
- 1ステップでしか成立しない「片道切符」のマイグレーションは原則禁止。
- Blue-Green / Rolling Update / Feature Flag 等、段階的リリースを前提とする。

> Check例  
> - 旧バージョンのアプリが新スキーマで動作可能か  
> - マイグレーション手順に「戻し方」が記載されているか

---

### 3.4 Job / Batch Executions

**INV-OPS-004: バッチ／ジョブは再実行可能であること**

- 途中で失敗しても、再実行で整合が取れること。
- 「全件削除→全件再投入」方式が本番データで安易に使われないこと。
- 再実行時に重複や欠損が発生しないよう、キー設計・フラグ設計を行うこと。

> Check例  
> - 再実行時の重複挙動について説明できるか  
> - データクリーニング系バッチにセーフティがあるか

---

### 3.5 Observability

**INV-OPS-005: トラブルシュート可能な観測性を保つ**

- 重大なビジネスイベントには、最低限のログ／メトリクスが存在すること。
- PII/Sensitive情報を直接ログに吐かない（Security invariantと連携）。
- 「何が起きていたか」を後から追えることを優先する。

> Check例  
> - 失敗時に原因を特定できるログがあるか  
> - 監視のアラート条件と設計意図が矛盾していないか

---

## 4. How This Is Used in Review

- スプリントのアーキテクチャレビュー時に、  
  変更がどのインバリアントに関係するかを確認する。
- GenAIレビューには、この `ops_invariants.md` をコンテキストとして渡し、  
  「今回の差分がどのインバリアントを脅かしているか」をコメントさせる。
- CIレベルでは、  
  - マイグレーションスクリプト  
  - バッチ定義  
  - デプロイ設定（Rolling/Blue-Green等）  
  を対象に、静的に違反が疑われる箇所を検知する。

---

## 5. Notes

- インバリアントはプロジェクトの学びに応じて更新される。  
- 守れなかった／守りづらかったケースは raw-notes に記録し、  
  必要に応じてこのドキュメントを改訂する。