# Step 1: 利用明細独立とKafka移行

## 目的 (Purpose)
本Transition Architectureは、社食・人事・社内コンビニ間で発生している**金額不整合および遅延処理**を段階的に解消し、最終的に**イベント駆動・リアルタイム連携基盤**へ移行することを目的とする。  
リスクを抑えつつ短期間で効果を可視化するため、
- 利用明細 (transactions) を人事側に新しく建てる
- CSV連携をKafkaに移行する

## 範囲 (Scope)
- **利用明細独立**
  - Source: 社食システム（社内コンビニ由来データ、ラインアイテムレベル）
  - Target: 人事システム（社食 + コンビニ統合データ、決済金額レベル）
- **データ連携**
  - 社食 --> 人事：決済履歴をCSV→Kafka連携へ移行
  - 人事 --> 社食：社員台帳（社内プロファイル）をイベント配信化

## 制約 (Constraints)
- 利用明細はほぼ新規作成に近く、既存テストケース参照不可
- 社内コンビニからの直接Kafka連携はプロジェクトタイミングが間に合わない可能性があるため
  - 社内コンビニシステムからはCSV受信
  - CSVの内容をイベントデータ化してKafkaに連携する変換コネクタを開発
- 決済データにはPIIが含まれるため、取り扱いはData Classification Policyを遵守する。
  - Kafkaを含むすべてのシステムで、PIIの保護・アクセス制御方針をプロジェクトフェーズで策定・実装することを必須とする。

## Consequences

### Positive
- 段階的移行の最初のステップとして、以降のイベント駆動化への基盤を築ける  
- 単純なCRUDサービスで、かつValue Objectを格納する利用明細を切り出すことで、レガシーからのマイクロサービスの切り出しの知見を深める
- ダークローンチで並行稼働期間中の障害発生時にプライオリティ調整をしやすくする
  - 本ステップでのユーザーリリースは予定していない。

### Negative
- 既存CSV経路とKafka経路の**二重運用期間**が発生し、オペレーションコストが一時的に増加  
- 並行稼働中のデータ整合性チェック負荷が高く、突合不一致時のトリアージが複雑化  
- Kafka連携ノウハウ不足による初期Enablementコスト 

### Mitigations 
- 二重運用期間を明示的に設定（最大3ヶ月）し、突合プロセスを標準化  
- 過去のCSVを**鏡データ（Baseline）**としてリプレイテストを実施  
- Kafka連携はPlatformチームのEnablement支援を受けて、監視・リカバリ運用をテンプレート化

## Reference
- principle-001: Single Source of Truth  
- principle-002: リアルタイムデータ処理  
- principle-003: イベント駆動アーキテクチャ  