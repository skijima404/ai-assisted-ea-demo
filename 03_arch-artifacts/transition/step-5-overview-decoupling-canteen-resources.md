# Step 5: 社食アプリケーションの疎結合化とAPI移行

## 目的 (Purpose)
本ステップは旧社食アプリケーションのリタイアに向けて残りの機能をマイクロサービスとし、移行を完成させることを目的とする。
人事システムとの連携が必要な箇所は全て終了しているため、以降は社食システム内のリファクタリングとなる。
リファクタリング間政治は、運用、監視、SLOを正式化し、疎結合、イベント駆動、オートスケールが通常運用の標準として定着する状態を目指す。

## 範囲 (Scope)
- **社食側マイクロサービス独立**
  - メニュー
  - ユーザープロファイル
- **運用・監視の定着**
  - SLO/SLI（レイテンシ/エラー率/スループット）とアラート閾値の確定
  - オンコール/エスカレーション/変更管理のフロー確立
  - コスト最適化（HPA/クォータ/PodAutoscaler の閾値チューニング）

## 制約 (Constraints)
- 移行用APIであったRead Only API (Camel) から、マイクロサービスから提供するAPIへの切り替え
  - インターフェースの破壊的変更ではないため、APIバージョンアップ扱いとしない。
- 旧系撤去は**段階的**（Read Only 化 → トラフィック完全停止 → データ凍結 → スナップショット保全 → 廃止）。

## Exit Criteria（完了条件）
- SLO 達成が 30 日連続（昼ピーク含む）。  
- 旧系停止後の監査（アクセス不可／データ凍結確認）完了。  
- 運用移管完了（オンコール／Runbook／ダッシュボードの引継ぎ）。

## Consequences

### Positive
- Kafka を唯一の正規連携に統一することで、**データリネージ**と**再現性**が向上。
- 旧来 API/バッチが消滅し、**保守コスト**と**運用負債**が大幅に減る。
- SLO/SLI とオートスケールのチューニングにより、**昼ピークのコスト効率**が最適化。

### Negative
- 切替期間中は**二重運用（監視/周知/問い合わせ対応）**の負担が増える。
- API 版固定により、軽微な仕様改善も凍結される期間が発生。
- レガシー撤去後の再学習（運用手順/ダッシュボード慣熟）が必要。

### Mitigations
- Hypercare 体制（SRE/EA/Dev 同席）で初週の**昼ピーク帯**をライブ監視。  
- 変更凍結期間を短期化し、改善提案はバックログに蓄積して**小出しリリース**へ。  
- 教育資材（Runbook/動画/ダッシュボード操作メモ）を準備し、運用トレーニングを実施。  
- 重要エンドポイントは **合成監視**＋**パケットミラー**で事前検知範囲を拡大。

## Reference
- principle-001: Single Source of Truth  
- principle-002: リアルタイムデータ処理  
- principle-003: イベント駆動アーキテクチャ  
- principle-006: Security First
