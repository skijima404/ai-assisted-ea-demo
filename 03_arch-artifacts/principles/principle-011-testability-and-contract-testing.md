---
id: principle-011
title: Testability & Contract Testing（検証容易性と契約テスト）
tags: [principle, project]
status: approved
approver: Architecture Board
approved_on: 2025-11-12
---

# Testability & Contract Testing（検証容易性と契約テスト）

## Statement
システム設計において検証容易性（Testability）を最優先事項とし、すべてのサービス間通信には契約テスト（Contract Test）を必須とする。テストピラミッドを正常化し、単体テスト・統合テスト・契約テストを充実させることで、E2Eテストへの過剰依存を解消する。

## Rationale
現行システムではリグレッションテストの成功条件が曖昧で、テストケースが実際のビジネス要件を表していない。テストピラミッドが逆三角形構造となり、E2Eテストへの過剰依存が発生している。特に、APIを提供しながら契約テストが実装されていないケースが非常に多く、インターフェースの変更が下流システムに予期せぬ影響を与えている。

マイクロサービスアーキテクチャやイベント駆動アーキテクチャでは、サービス間の契約が明示的に管理されていないと、統合時の問題発見が遅れ、リリース遅延や本番障害のリスクが高まる。

検証容易性を設計の最初から考慮し、契約テストを標準化することで：
- サービス間の依存関係を明確化し、破壊的変更を早期検出できる
- 各サービスが独立してテスト可能になり、開発速度が向上する
- リグレッションテストの代わりに、信頼性の高い自動テストスイートを構築できる
- 並行稼働やカナリアリリースなど、安全な移行戦略を実現できる

## Implications
- **契約テストの必須化**:
  - すべてのサービス間通信（REST API, gRPC, イベント等）に対して契約テストを実装する
  - 契約テストはCI/CDパイプラインに組み込み、破壊的変更を自動検出する
  - Provider側とConsumer側の両方で契約を検証する（Consumer-Driven Contract Testing）
  
- **テストピラミッドの正常化**:
  - 単体テスト（Unit Test）を最も多く実装し、変更の影響を即座に検知する
  - 統合テスト（Integration Test）でサービス間の連携を検証する
  - E2Eテストは最小限にし、重要なユーザーシナリオに絞る
  
- **設計段階でのTestabilityの考慮**:
  - Transition Architectureの意思決定において、検証容易性を最重要項目として評価する
  - モックやスタブを容易に作成できるインターフェース設計を採用する
  - テスト実行時間を最小化するため、外部依存を分離可能にする
  
- **並行稼働による実データ検証**:
  - リグレッションテストが不十分な場合、新旧システムの並行稼働で実データを使った検証を行う
  - パケットミラーリングや処理結果の比較により、移行の安全性を担保する
  - ダークローンチやCanary Releaseを活用し、段階的に検証範囲を拡大する
  
- **テストの継続的メンテナンス**:
  - 自動テストスイートを継続的にメンテナンスし、結果の信頼性を確保する
  - テストケースはビジネス要件に基づき、明確な期待値を持つ
  - コード品質メトリクスをCI/CDに組み込み、技術的負債の蓄積を防ぐ

## Related Principles
- principle-008 (Data Contract & Schema Evolution)
- principle-004 (Microservices)
- principle-003 (Event Driven Architecture)
- principle-007 (Observability)
- principle-010 (Manage Technical Debt as a Portfolio)

## Linked Vision
アーキテクチャビジョン 1. 信頼される決済・精算基盤の構築 - 品質と安全性の確保
アーキテクチャビジョン 3. 柔軟で持続可能なシステム基盤の実現 - 継続的な改善と進化

