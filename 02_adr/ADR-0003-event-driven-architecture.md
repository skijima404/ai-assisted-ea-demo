# ADR-0003: Event Driven Architecture (イベント駆動アーキテクチャ)

## Status
Accepted

## Context

### 問題の背景

現状のシステム間連携には、複数の構造的な問題がある。

**連携方式の問題**:
- 社食システム、人事システムともにWeb APIが提供されていない
- システム間のデータのやり取りはファイルとバッチで実施されている
- 同期的なシステム間連携がない

**データ不整合の問題**:
- バッチ処理による遅延でデータ不整合が発生
- 表示ロジックと精算ロジックが異なるタイミングで更新される

**密結合の問題**:
- システム間の密結合により、段階的な改善が困難
- 責務の分離が不適切（社食アプリがコンビニ履歴も表示）

**負荷集中の問題**:
- ピーク時間帯（12:00-13:00）に負荷が集中
- 同期処理のため、ピーク時の書き込み負荷がそのままシステムに波及

**ビジョンとの関連**:
- アーキテクチャビジョン「1. 信頼される決済・精算基盤の構築 - 堅実なデータ連携」を実現するため

## Decision

**イベント駆動アーキテクチャを採用し、非同期かつ業務価値に応じた鮮度でイベントを流通させる**

システム間連携は、イベント駆動アーキテクチャを基盤とし、疎結合かつ非同期で実装する。すべての処理をリアルタイム化するのではなく、業務上必要な鮮度に応じてイベントを配信することで、効率的かつ柔軟な連携を実現する。

## Implications

- 各システムはイベントベースの連携に対応し、依存関係を疎結合化する
- イベントの鮮度と重要度に応じて、リアルタイム処理とバッチ処理を使い分ける設計となる
- ピーク時の負荷はイベントキューで吸収し、非同期処理で平準化する
- イベントスキーマを共通化し、後方互換性を保ちながら管理する
- 主要イベントはイベントソーシングパターンで管理し、整合性の再構築を可能とする

## Consequences

### Positive
- システム間の疎結合と非同期連携により、柔軟で拡張性の高い構成になる
- 負荷ピーク時の処理を平準化し、システムの安定性が向上する
- イベントソーシングによりデータ整合性を保ちやすくなる
- 段階的な改善と移行が可能になり、リスクを抑制できる

### Negative
- イベントストリーミング基盤の導入・運用コストが発生する
- 非同期処理のため、デバッグや運用の複雑さが増す
- イベントスキーマの管理とバージョン管理が必要となる
- 新たな技術習得や運用ルールの整備が求められる

### Mitigation
- イベントスキーマのバージョン管理を徹底し、後方互換性を維持する
- 分散トレーシングなどの観測可能性を強化する
- パイロットプロジェクトで検証し、段階的に導入を進める

## Reference
- Architecture Vision: `03_arch-artifacts/arch-vision.md`
- Analysis: `01_working/bd_arch-design/20_analysis/2025-11-06-system-integration-issues.md`
- Analysis: `01_working/bd_arch-design/20_analysis/2025-11-06-amount-inconsistency-root-cause.md`
- Principle: `03_arch-artifacts/principles/principle-003-event-driven-architecture.md`

