# ADR-0011: Testability & Contract Testing（検証容易性と契約テスト）

## Status
Accepted

## Context

### 問題の背景

現行システムにおいて、テストと品質保証に深刻な問題が発生している。

**リグレッションテストの品質問題**:
- リグレッションテストの成功条件が「適切に動くこと」とされ、明確な期待値が存在しない
- 過去のテストケースを確認したが、「適切」が何を意味するかが記述されていない
- テストケースが実際のビジネス要件を表しておらず、画面の動作確認リストに近い
- 自動テストは一部存在するが、メンテナンスされておらず、結果の信頼性が低い

**テストピラミッドの逆転**:
- テストピラミッドが逆三角形構造となり、E2Eテストへの過剰依存が発生
- 単体テスト・統合テストが不足し、変更影響の検知が困難
- E2Eテストは実行時間が長く、フィードバックサイクルが遅い

**契約テストの欠如**:
- **APIを提供しているにもかかわらず、契約テスト（Contract Test）が実装されていない**
- サービス間のインターフェース変更が下流システムに予期せぬ影響を与えている
- 破壊的変更が本番環境で初めて発覚するケースが多発
- データ構造の非互換やAPI仕様の不整合が頻繁に発生

**コード品質とTestabilityの問題**:
- コードの複雑度が高く、特にプレゼンテーションレイヤーとビジネスロジックレイヤーは分離されておらず、境界線が曖昧
- UIとビジネスロジックの結合度が高く、テストが困難
- テストを考慮した設計になっておらず、モックやスタブの作成が困難

**移行プロジェクトへの影響**:
- リグレッションテストが不十分なため、移行後の品質保証が困難
- マイクロサービス化により、サービス間の依存関係が増加するが、それを検証する仕組みがない
- 並行稼働やカナリアリリースといった安全な移行戦略を実現する基盤が不足

**ビジョンとの関連**:
- アーキテクチャビジョン「1. 信頼される決済・精算基盤の構築 - 品質と安全性の確保」を実現するため
- アーキテクチャビジョン「3. 柔軟で持続可能なシステム基盤の実現 - 継続的な改善と進化」を実現するため

## Decision

**「Testability & Contract Testing（検証容易性と契約テスト）」原則を採用する**

システム設計において検証容易性（Testability）を最優先事項とし、すべてのサービス間通信には契約テスト（Contract Test）を必須とする。テストピラミッドを正常化し、単体テスト・統合テスト・契約テストを充実させることで、E2Eテストへの過剰依存を解消する。

### 実装への影響（Implications）

**契約テストの必須化**:
- すべてのサービス間通信（REST API, gRPC, イベント等）に対して契約テストを実装する
- 契約テストはCI/CDパイプラインに組み込み、破壊的変更を自動検出する
- Provider側とConsumer側の両方で契約を検証する（Consumer-Driven Contract Testing）
- Pact、Spring Cloud Contract等のツールを活用する

**テストピラミッドの正常化**:
- 単体テスト（Unit Test）を最も多く実装し、変更の影響を即座に検知する
- 統合テスト（Integration Test）でサービス間の連携を検証する
- 契約テスト（Contract Test）でサービス間のインターフェースを検証する
- E2Eテストは最小限にし、重要なユーザーシナリオに絞る

**設計段階でのTestabilityの考慮**:
- Transition Architectureの意思決定において、検証容易性を最重要項目として評価する
- モックやスタブを容易に作成できるインターフェース設計を採用する
- テスト実行時間を最小化するため、外部依存を分離可能にする
- 依存性注入（Dependency Injection）を活用し、テスト可能な設計にする

**並行稼働による実データ検証**:
- リグレッションテストが不十分な場合、新旧システムの並行稼働で実データを使った検証を行う
- パケットミラーリングや処理結果の比較により、移行の安全性を担保する
- ダークローンチやCanary Releaseを活用し、段階的に検証範囲を拡大する
- 参考: STAR by Mike Amundsen

**テストの継続的メンテナンス**:
- 自動テストスイートを継続的にメンテナンスし、結果の信頼性を確保する
- テストケースはビジネス要件に基づき、明確な期待値を持つ
- コード品質メトリクスをCI/CDに組み込み、技術的負債の蓄積を防ぐ

### 関連する原則
- ADR-0008: Data Contract & Schema Evolution（データ契約の厳格な管理）
- ADR-0004: Microservices Architecture（サービス間の依存関係管理）
- ADR-0003: Event Driven Architecture（イベント契約の検証）
- ADR-0007: Observability（テスト結果の可視化）
- ADR-0010: Manage Technical Debt as a Portfolio（品質維持）

## Alternatives Considered

### 1. E2Eテスト中心のアプローチ
- 現状のまま、E2Eテストを充実させる案
- **却下理由**: 
  - E2Eテストは実行時間が長く、フィードバックサイクルが遅い
  - 変更の影響範囲が特定しにくい
  - メンテナンスコストが高い

### 2. リグレッションテストの改善のみ
- 既存のリグレッションテストの品質を改善する案
- **却下理由**:
  - テストピラミッドの逆転を解消できない
  - 契約テストの欠如による問題を解決できない
  - マイクロサービス化に対応できない

### 3. 契約テストとテストピラミッド正常化の両立（採用案）
- 契約テストを必須化し、テストピラミッドを正常化する案
- **採用理由**:
  - マイクロサービス化に適合
  - 変更の影響を早期に検知できる
  - フィードバックサイクルが速い
  - 移行戦略（並行稼働、カナリアリリース）を実現できる

## Consequences

### Positive
- 契約テストにより、サービス間の破壊的変更を自動検出できる
- テストピラミッドの正常化により、変更の影響を早期に検知できる
- テスト実行時間が短縮され、フィードバックサイクルが速くなる
- 並行稼働やカナリアリリースにより、移行の安全性が向上する
- 開発者が安心してリファクタリングや機能追加を行える
- CI/CDパイプラインが安定し、デプロイ頻度を上げられる
- ドキュメントとしても機能し、サービス間の依存関係が明確になる

### Negative
- 契約テストやテストピラミッド整備の初期コストが発生
- 開発者のテストスキル向上が必要（トレーニングコスト）
- CI/CDパイプラインの整備が必要
- 並行稼働による運用コストが増加
- テストの継続的メンテナンスが必要

### Mitigation
- メニューサービスなど、小さなサービスから契約テストを導入し、学習コストを分散する
- Platform EngineeringによりテストテンプレートやCI/CDパイプラインを標準化し、各チームの負担を軽減
- Enablementプログラムを策定し、開発者のテストスキルを向上させる
- OpenShiftやService Meshの標準監視メトリクスを活用し、並行稼働の運用コストを抑制
- Canary ReleaseやDark Launchを活用し、影響範囲を段階的に拡大

## Reference
- Architecture Vision: `03_arch-artifacts/arch-vision.md`
- Analysis: 
  - `01_working/ef_solutions/20_analysis/2025-11-07-testing-and-quality-assurance.md`
  - `01_working/ef_solutions/20_analysis/2025-11-07-service-decomposition-and-dependencies.md`
  - `01_working/ef_solutions/20_analysis/2025-11-07-ui-api-separation-strategy.md`
- Principle: `03_arch-artifacts/principles/principle-011-testability-and-contract-testing.md`
- External Reference: STAR by Mike Amundsen (https://mamund.site44.com/talks/2021-05-orm-migration/2021-05-orm-migration.pdf)

