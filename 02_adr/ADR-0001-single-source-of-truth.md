# ADR-0001: データ整合性確保のための単一データソース化戦略

## Context

現状の社食・人事・コンビニの各システムは、  
- それぞれ独立したデータストアを持ち、  
- 同じ取引データを別経路で計算・表示している。  

この構造により、**「金額不整合」や「更新タイミング差」**が発生し、問い合わせ・再計算コストが高騰している。  
特に以下の課題が明確になった：

- 表示系と精算系が異なるテーブルを参照している  
- 割引や税情報がデータモデルに明示的に存在しない  
- 不整合を検知・防止する仕組みが存在しない  

アーキテクチャ原則「Single Source of Truth」を踏まえ、  
どのように“単一の信頼できる情報源”を構築するかを検討する。

## Decision

単一の「決済イベントストリーム」を真実の源とし、  
すべてのシステムがこのイベントを参照して整合性を保つ方式を採用する。

- 決済発生時点でイベントを発行し、Kafka上で管理する  
- イベント内容は割引・税額などを含む**正規化済みトランザクション構造**とする  
- 下流システム（社食・人事・分析系）はこのイベントを購読して各自のストアを更新  
- 画面表示・精算・請求台帳は全て同一イベントソースに基づいて再構築する  

## Alternatives Considered

1. **既存テーブルのマスタ化**  
   - 各システムのうち1つ（例：人事）を“正”として他が同期する案。  
   - → データ依存が残り、更新順序・APIレートで整合性が崩れる懸念。

2. **共通DBへの統合**  
   - 全システムが共通DBを参照する構成。  
   - → 運用・スキーマ変更の影響範囲が広く、分散チームでの変更調整がボトルネック。

3. **イベントソーシング（採用案）**  
   - 非同期連携でもデータ鮮度と一貫性の両立が可能。  
   - → 導入コストはあるが、移行ステップを分割できる。

## Consequences

- データ整合性は決済イベントを単位に保証される  
- 履歴と再計算の両方がイベントから再現可能  
- システム間の同期バッチが不要になり、処理フローが単純化  
- 移行初期はイベント生成と購読の両環境を併用する必要がある（Parallel Run）  
- 開発チームにはイベントスキーマ管理・バージョニングの運用知識が求められる

## Linked Artifacts

- principle-001: Single Source of Truth  
- principle-003: Event Driven Architecture  
- vision-001: 信頼される決済・精算基盤の構築
