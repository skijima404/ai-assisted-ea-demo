# ADR-0002: Real-time Data Processing (リアルタイムデータ処理)

## Status
Accepted

## Context

### 問題の背景

現状、バッチ処理による遅延が多数のユーザー体験問題を引き起こしている。

**遅延の具体例**:
1. **利用履歴の反映遅延**:
   - 社食を利用した翌日にならないと金額が反映されない
   - 月末に食べ過ぎて予算超過した結果、天引きで引かれた額が予想外に多く、銀行振込された金額が少なくて困る

2. **新入社員のオンボーディング遅延**:
   - 新入社員がアプリを使えるようになるまでに約1週間かかる
   - 人事システムとのID連携処理が遅く、社員情報の登録反映が翌週になる
   - 初日から社食を利用できず、新入社員の体験が悪化

3. **退職者のアカウント無効化遅延**:
   - 退職者のアカウントが削除されず、退職後もしばらく利用できる
   - セキュリティリスクが継続する

**根本原因**:
- システム間のデータ連携がファイルとバッチで実施されている
- Web APIが提供されていない
- リアルタイム連携の仕組みがない

**ビジョンとの関連**:
- アーキテクチャビジョン「1. 信頼される決済・精算基盤の構築 - 透明性と即時性の確保、堅実なデータ連携」を実現するため

## Decision

**リアルタイムデータ処理は、業務価値に応じて適切な鮮度を設計し、必要な範囲で適用する。**

すべてのデータ連携を無条件にリアルタイム化するのではなく、利用シーンや業務インパクトに基づき、即時性が求められるものにはリアルタイム処理を導入し、そうでないものは適切なバッチ処理や遅延許容範囲を設定する。

具体的には、
- 社食利用履歴の即時反映や給与天引き予定額の迅速な更新など、ユーザー体験に直結する部分はリアルタイム化を優先する
- 新入社員のID連携や退職者のアカウント管理など、遅延が業務リスクや体験に大きく影響するケースも優先的に改善する
- それ以外の処理は、業務価値に応じたSLA（例：即時、数分以内、日次など）を設定し、実現可能な範囲で運用する

この方針により、システム全体の複雑性とコストを抑えつつ、重要な業務価値を確保する。

### 実装への影響（Implications）
- データ連携の鮮度要件を業務価値に応じて定義し、SLAを明確化する
- イベントストリーミングやChange Data Capture（CDC）などを活用し、即時性が必要な処理を実現
- 非即時処理はバッチ処理を継続し、効率化を図る
- ソースシステム（例：人事システム）はイベント発行や変更通知の標準化を進める
- UI上で更新遅延を明示し、ユーザーに透明性を提供する（例：「最終更新 5分前」）

### 関連する原則
- ADR-0003: Event Driven Architecture（イベント駆動による非同期連携）

## Consequences

### Positive
- 給与天引き予定額や利用明細が迅速に確認でき、ユーザー体験が向上
- 新入社員のオンボーディングがスムーズになり、初日から社食利用が可能に
- 退職者のセキュリティリスクを早期に解消
- 透明性が向上し、システム全体の信頼性が高まる

### Negative
- イベントストリーミングやCDCなどの新技術導入による運用負荷増加
- リアルタイム処理のための運用体制構築が必要
- 全てをリアルタイム化しないため、鮮度要件の設計と調整が複雑になる可能性

### Mitigation
- 業務価値に基づく鮮度要件の明確化と優先順位付けを徹底する
- 非即時処理はバッチ処理の効率化でカバーし、過度なリアルタイム化を避ける
- パイロットプロジェクトで技術検証を行い、段階的に導入を進める

## Reference
- Architecture Vision: `03_arch-artifacts/arch-vision.md`
- Analysis: `01_working/bd_arch-design/20_analysis/2025-11-06-new-employee-onboarding-delay.md`
- Analysis: `01_working/bd_arch-design/20_analysis/2025-11-06-ex-employee-account-management.md`
- Analysis: `01_working/bd_arch-design/20_analysis/2025-11-06-system-integration-issues.md`
- Principle: `03_arch-artifacts/principles/principle-002-realtime-data-processing.md`
