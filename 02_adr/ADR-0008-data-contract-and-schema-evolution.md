# ADR-0008: Data Contract & Schema Evolution (データ契約とスキーマ進化)

## Status
Accepted

## Context

### 問題の背景

現状、データ構造の非互換やAPI仕様の不整合が、システム改善の大きな障壁になっている。

**データモデルの不整合**:
- 社食システム: 2層構造（`receipts`, `receipt_items`）で割引情報を表現可能
- コンビニシステム: 1層構造（`convini_receipt_items`）で割引情報を表現できない
- 機能追加（10%割引）時に、データ構造の違いが問題を引き起こした

**変更の影響範囲の大きさ**:
- 割引機能のような新機能追加時に、システム全体への影響が発生
- 初期開発時に割引のユースケースがなく、後から追加する際に設計変更が必要
- 担当バックエンドパートナーとのコミュニケーション不全により、問題が発生

**モノリス構造の影響**:
- コンポーネント間の依存関係が強く、個別の変更が困難
- バージョン間の破壊的変更により、システム全体のアップグレードが必要

**マイクロサービス化への移行**:
- マイクロサービスアーキテクチャを採用する場合、サービス間のデータ契約管理が重要
- 破壊的変更を避け、後方互換性を維持しながら継続的な改善を可能にする必要

**ビジョンとの関連**:
- アーキテクチャビジョン「1. 信頼される決済・精算基盤の構築 - 単一の信頼できる情報源」
- アーキテクチャビジョン「3. 柔軟で持続可能なシステム基盤の実現 - 変化に強い仕組み」

## Decision

**「Data Contract & Schema Evolution (データ契約とスキーマ進化)」原則を採用する**

サービス間のデータ契約（Data Contract）は厳格に管理し、スキーマの変更は進化的（Evolutionary）に行う。破壊的変更を避け、後方互換性を維持しながら継続的な改善を可能にする。

### 実装への影響（Implications）
- すべてのサービス間通信は明示的なデータ契約を持つ（例: OpenAPI, AsyncAPI, Avro Schema）
- スキーマ変更は後方互換性を維持し、破壊的変更の場合は新バージョンを明示的に発行する
- スキーマリポジトリを集中管理し、契約変更時には影響範囲を自動分析する
- コードレビューやCI/CDパイプラインに契約テストを組み込み、破壊的変更を自動検出する
- データ移行時はスキーマバージョンごとに段階的移行を行う（デュアルライティング等）

### 関連する原則
- ADR-0001: Single Source of Truth（データモデルの統一）
- ADR-0003: Event Driven Architecture（イベントスキーマの管理）
- ADR-0005: Autoscaling（スケーリング時のデータ整合性）

## Consequences

### Positive
- 依存関係を最小化し、継続的な機能拡張とモダナイゼーションを両立できる
- 破壊的変更を自動検出し、影響範囲を明確化できる
- スキーマバージョニングにより、段階的な移行が可能
- 契約テストにより、変更の安全性と透明性を担保

### Negative
- スキーマリポジトリの管理コストが発生
- 契約テストの整備と維持にコストが必要
- デュアルライティングなど、移行時の複雑性が増加

### Mitigation
- スキーマリポジトリを自動化し、管理コストを削減
- CI/CDパイプラインに契約テストを組み込み、自動化
- 段階的な移行により、リスクを最小化

## Reference
- Architecture Vision: `03_arch-artifacts/arch-vision.md`
- Analysis: `01_working/bd_arch-design/20_analysis/2025-11-06-amount-inconsistency-root-cause.md`
- Principle: `03_arch-artifacts/principles/principle-008-data-contract-and-schema-evolution.md`

